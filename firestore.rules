
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can be read by anyone but only created/updated by themselves
    // or admins. Deletion is restricted to admins.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Subscription plans can be read by any authenticated user, but only
    // managed by admins.
    match /subscriptionPlans/{planId} {
      allow read: if request.auth != null;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Payments can be created by the user they belong to. They can be read
    // by the user or any admin.
    match /payments/{paymentId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Support tickets can be created by the user they belong to.
    // They can be read by the user or any admin.
    // They can only be updated by an admin.
    match /supportTickets/{ticketId} {
      allow create: if request.resource.data.userId == request.auth.uid;
      allow read: if request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Notifications can be read by the user they belong to.
    // They can be created by the system (server-side actions).
    match /notifications/{notificationId} {
        allow read: if request.auth.uid == resource.data.userId;
        allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' || request.auth.uid == request.resource.data.userId; // Allow admin or system to create
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Branding settings can only be read/written by admins.
    match /branding/{docId} {
        allow read: if request.auth != null;
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
